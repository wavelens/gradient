<!--
 * SPDX-FileCopyrightText: 2025 Wavelens GmbH <info@wavelens.io>
 *
 * SPDX-License-Identifier: AGPL-3.0-only
 -->

 {% extends 'dashboard/index.html' %}

 <head>
    {% load static %}
    {% load i18n %}
</head>

{% block title %}{% trans 'Register' %}{% endblock %}

{% block content %}
<div class="outer-form">
    <div class="form-container">
        {% if disable_registration or oidc_required %}
            <!-- Registration is disabled -->
            <h2 class="form-header-label">{% trans 'Registration Unavailable' %}</h2>
            <div class="registration-disabled">
                {% if oidc_required %}
                    <p>{% trans 'Registration is only available through SSO. Please use the login page to sign in with your organization account.' %}</p>
                    {% if oidc_enabled %}
                        <div class="sso-login-section">
                            <a href="{{ api_base_url }}/auth/oidc/login" class="sso-btn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                                </svg>
                                {% trans 'Continue with SSO' %}
                            </a>
                        </div>
                    {% endif %}
                {% else %}
                    <p>{% trans 'New user registration has been disabled by the administrator.' %}</p>
                {% endif %}
                <div class="register">
                    <a class="register blue-link" href="{% url 'login' %}">{% trans 'Back to Login' %}</a>
                </div>
            </div>
        {% else %}
            <!-- Normal registration form -->
            <h2 class="form-header-label">{% trans 'Register' %}</h2>
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}
            <form method="post">
                {% csrf_token %}
                {% for field in form %}
                    <div class="form-field">
                        <label for="{{ field.id_for_label }}" class="required-label">{% trans field.label %}</label>
                        {% if field.name == 'username' %}
                            <div class="input-with-icon">
                                {{ field }}
                                <div class="field-status" id="username-status"></div>
                            </div>
                        {% else %}
                            {{ field }}
                        {% endif %}
                        {% if field.errors %}
                            <div class="error">{{ field.errors }}</div>
                        {% endif %}
                        {% if field.help_text and field.name != 'username' and field.name != 'password' %}
                            <small class="form-help-text">{{ field.help_text }}</small>
                        {% endif %}
                        {% if field.name == 'password' %}
                            <div class="password-requirements">
                                <div class="requirement" id="length-req">
                                    <span class="req-text">8-128 characters</span>
                                </div>
                                <div class="requirement" id="uppercase-req">
                                    <span class="req-text">One uppercase letter</span>
                                </div>
                                <div class="requirement" id="lowercase-req">
                                    <span class="req-text">One lowercase letter</span>
                                </div>
                                <div class="requirement" id="digit-req">
                                    <span class="req-text">One digit</span>
                                </div>
                                <div class="requirement" id="special-req">
                                    <span class="req-text">One special character</span>
                                </div>
                                <div class="requirement" id="no-password-req">
                                    <span class="req-text">No word 'password'</span>
                                </div>
                                <div class="requirement" id="no-sequential-req">
                                    <span class="req-text">No sequential characters</span>
                                </div>
                                <div class="requirement" id="no-repeated-req">
                                    <span class="req-text">No repeated characters</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
                <button type="submit" class="submit-btn">{% trans 'Register' %}</button>
            </form>
            <div class="register">{% trans 'Already have an account?' %}<a class="register blue-link" href="{% url 'login' %}?next=/account/login">{% trans 'Login' %}</a></div>
        {% endif %}
    </div>
</div>

<style>
.registration-disabled {
    text-align: center;
    padding: 2rem 0;
}

.registration-disabled p {
    color: #6b7280;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.sso-login-section {
    margin-bottom: 1.5rem;
}

.sso-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.75rem 1rem;
    background: #fff;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    color: #374151;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
}

.sso-btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
    text-decoration: none;
    color: #374151;
}

.sso-btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Username validation
    const usernameInput = document.getElementById('username-input');
    if (usernameInput) {
        let usernameCheckTimeout;
        const usernameStatus = document.getElementById('username-status');
        
        usernameInput.addEventListener('input', function() {
            const username = this.value;
            
            // Clear previous timeout
            clearTimeout(usernameCheckTimeout);
            
            if (!username) {
                updateUsernameStatus('neutral');
                return;
            }
            
            const requirements = validateUsername(username);
            const isValidFormat = requirements.length && requirements.chars && 
                                requirements.startEnd && requirements.consecutive && requirements.reserved;
            
            if (!isValidFormat) {
                updateUsernameStatus('error', 'Invalid username format');
                return;
            }
            
            // Show loading and check availability
            updateUsernameStatus('loading', 'Checking availability...');
            
            // Debounce API calls
            usernameCheckTimeout = setTimeout(() => {
                checkUsernameAvailability(username);
            }, 500);
        });
    }
    
    // Password validation
    const passwordInput = document.getElementById('password-input');
    if (!passwordInput) return;
    
    const passwordField = passwordInput.closest('.form-field');
    const requirementsDiv = passwordField.querySelector('.password-requirements');
    
    // Add password strength indicator at the top of requirements
    const strengthContainer = document.createElement('div');
    strengthContainer.className = 'password-strength';
    strengthContainer.innerHTML = '<div class="password-strength-bar"></div>';
    requirementsDiv.insertBefore(strengthContainer, requirementsDiv.firstChild);
    
    const strengthBar = strengthContainer.querySelector('.password-strength-bar');
    
    function validateUsername(username) {
        const requirements = {
            length: username.length >= 3 && username.length <= 50,
            chars: /^[a-zA-Z0-9_-]*$/.test(username),
            startEnd: username.length === 0 || (!username.startsWith('_') && !username.startsWith('-') && 
                     !username.endsWith('_') && !username.endsWith('-')),
            consecutive: !/(__|--|_-|-_)/.test(username),
            reserved: !['admin', 'root', 'system', 'api', 'www', 'mail', 'ftp', 'test', 'user', 'support', 'help', 'info', 'null', 'undefined'].includes(username.toLowerCase())
        };
        
        return requirements;
    }
    
    function updateUsernameStatus(status, message = '') {
        const usernameStatus = document.getElementById('username-status');
        if (!usernameStatus) return;
        
        // Reset all classes
        usernameStatus.className = 'field-status';
        usernameStatus.innerHTML = '';
        usernameStatus.title = message;
        
        switch (status) {
            case 'success':
                usernameStatus.classList.add('success');
                usernameStatus.innerHTML = '<span class="material-icons">check_circle</span>';
                break;
            case 'error':
                usernameStatus.classList.add('error');
                usernameStatus.innerHTML = '<span class="material-icons">close</span>';
                break;
            case 'loading':
                usernameStatus.classList.add('loading');
                usernameStatus.innerHTML = '<span class="loader"></span>';
                break;
            case 'neutral':
            default:
                // No icon for neutral state
                break;
        }
    }
    
    async function checkUsernameAvailability(username) {
        try {
            const response = await fetch('/account/check-username/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({username: username})
            });
            
            const data = await response.json();
            
            if (data.available) {
                updateUsernameStatus('success', 'Username is available');
            } else {
                updateUsernameStatus('error', data.message || 'Username is not available');
            }
        } catch (error) {
            updateUsernameStatus('error', 'Error checking availability');
        }
    }

    function validatePassword(password) {
        const requirements = {
            length: password.length >= 8 && password.length <= 128,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            digit: /[0-9]/.test(password),
            special: /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password),
            noPassword: !password.toLowerCase().includes('password'),
            noSequential: !hasSequentialChars(password),
            noRepeated: !hasRepeatedChars(password)
        };
        
        return requirements;
    }
    
    function hasSequentialChars(str) {
        for (let i = 0; i <= str.length - 4; i++) {
            const substr = str.substr(i, 4);
            if (isSequential(substr)) return true;
        }
        return false;
    }
    
    function isSequential(s) {
        if (s.length !== 4) return false;
        
        // Check ascending
        let ascending = true;
        for (let i = 1; i < 4; i++) {
            if (s.charCodeAt(i) !== s.charCodeAt(i-1) + 1) {
                ascending = false;
                break;
            }
        }
        
        // Check descending
        let descending = true;
        for (let i = 1; i < 4; i++) {
            if (s.charCodeAt(i) !== s.charCodeAt(i-1) - 1) {
                descending = false;
                break;
            }
        }
        
        return ascending || descending;
    }
    
    function hasRepeatedChars(str) {
        for (let i = 0; i <= str.length - 3; i++) {
            if (str[i] === str[i+1] && str[i+1] === str[i+2]) {
                return true;
            }
        }
        return false;
    }
    
    function updateRequirements(requirements) {
        const reqElements = {
            length: document.getElementById('length-req'),
            uppercase: document.getElementById('uppercase-req'),
            lowercase: document.getElementById('lowercase-req'),
            digit: document.getElementById('digit-req'),
            special: document.getElementById('special-req'),
            noPassword: document.getElementById('no-password-req'),
            noSequential: document.getElementById('no-sequential-req'),
            noRepeated: document.getElementById('no-repeated-req')
        };
        
        Object.keys(requirements).forEach(key => {
            const element = reqElements[key];
            if (element) {
                element.classList.remove('valid', 'invalid');
                if (requirements[key]) {
                    // Hide valid requirements
                    element.style.display = 'none';
                } else {
                    // Show invalid requirements
                    element.style.display = 'flex';
                    element.classList.add('invalid');
                }
            }
        });
    }
    
    function updateStrengthBar(requirements) {
        const validCount = Object.values(requirements).filter(Boolean).length;
        const percentage = (validCount / 8) * 100;
        
        strengthBar.style.width = percentage + '%';
        
        // Remove all strength classes
        strengthBar.classList.remove('strength-weak', 'strength-fair', 'strength-good', 'strength-strong');
        
        if (percentage >= 100) {
            strengthBar.classList.add('strength-strong');
        } else if (percentage >= 75) {
            strengthBar.classList.add('strength-good');
        } else if (percentage >= 50) {
            strengthBar.classList.add('strength-fair');
        } else if (percentage > 0) {
            strengthBar.classList.add('strength-weak');
        }
    }
    
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        
        if (password.length === 0) {
            // Hide entire requirements section when empty
            requirementsDiv.style.display = 'none';
        } else {
            // Show requirements section and validate
            requirementsDiv.style.display = 'block';
            const requirements = validatePassword(password);
            updateRequirements(requirements);
            updateStrengthBar(requirements);
        }
    });
    
    // Initially hide the requirements section
    requirementsDiv.style.display = 'none';
});
</script>
{% endblock %}
