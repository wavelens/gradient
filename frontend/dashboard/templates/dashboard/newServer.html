<!--
 * SPDX-FileCopyrightText: 2025 Wavelens GmbH <info@wavelens.io>
 *
 * SPDX-License-Identifier: AGPL-3.0-only
 -->

 {% extends 'dashboard/index.html' %}

 <head>
    {% load static %}
    {% load i18n %}
</head>

{% block title %}{% trans 'New Server' %}{% endblock %}

{% block content %}
<div class="outer-form">
    <div class="form-container">
        <h2 class="form-header-label">{% trans 'New Server' %}</h2>
        <form method="post" id="server-form">
            {% csrf_token %}
            {% for field in form %}
                {% if field.name == 'organization' %}
                    {{ field }}
                {% elif field.name == 'architectures' %}
                    <div class="form-field">
                        <label for="{{ field.id_for_label }}" {% if field.field.required %}class="required-label"{% endif %}>{% trans field.label %}</label>
                        {{ field }}
                        <div class="tag-input-container">
                            <div class="tags-display" id="architectures-tags"></div>
                            <input type="text" class="form-control tag-input" id="architectures-input" placeholder="e.g. x86_64-linux, aarch64-linux, x86_64-darwin">
                        </div>
                        {% if field.errors %}
                            <div class="error">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                {% elif field.name == 'features' %}
                    <div class="form-field">
                        <label for="{{ field.id_for_label }}" {% if field.field.required %}class="required-label"{% endif %}>{% trans field.label %}</label>
                        {{ field }}
                        <div class="tag-input-container">
                            <div class="tags-display" id="features-tags"></div>
                            <input type="text" class="form-control tag-input" id="features-input" placeholder="e.g. docker, build, eval, compute">
                        </div>
                        {% if field.errors %}
                            <div class="error">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                {% elif field.field.widget|default:"" == form.fields.remember_me.widget %}
                    <div class="form-check">
                        {{ field }}
                        <label for="{{ field.id_for_label }}" class="form-check-label">{% trans field.label %}</label>
                    </div>
                {% else %}
                    <div class="form-field">
                        <label for="{{ field.id_for_label }}" {% if field.field.required %}class="required-label"{% endif %}>{% trans field.label %}</label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="error">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}

            {% if ssh_public_key %}
            <div class="form-field">
                <label class="form-label">{% trans 'SSH Public Key' %}</label>
                <div class="ssh-key-display">
                    <code id="ssh-public-key">{{ ssh_public_key }}</code>
                    <button type="button" class="copy-button" onclick="copyToClipboard('ssh-public-key')">{% trans 'Copy' %}</button>
                </div>
                <small class="form-text">{% trans 'Add this public key to your server'"'"'s ~/.ssh/authorized_keys file to allow Gradient to connect.' %}</small>
            </div>
            {% endif %}

            <button type="submit" class="submit-btn">{% trans 'Create' %}</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function initTagInput(inputId, displayId, hiddenId) {
        const input = document.getElementById(inputId);
        const display = document.getElementById(displayId);
        const hidden = document.getElementById(hiddenId);
        let tags = [];
        
        function updateHiddenField() {
            hidden.value = tags.join(',');
        }
        
        function addTag(tagText) {
            const trimmed = tagText.trim();
            if (trimmed && !tags.includes(trimmed)) {
                tags.push(trimmed);
                renderTags();
                updateHiddenField();
            }
        }
        
        function removeTag(tagToRemove) {
            tags = tags.filter(tag => tag !== tagToRemove);
            renderTags();
            updateHiddenField();
        }
        
        function renderTags() {
            display.innerHTML = '';
            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag';
                tagElement.innerHTML = `${tag}`;
                
                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'tag-remove';
                removeButton.innerHTML = '&times;';
                removeButton.onclick = function() {
                    removeTag(tag);
                };
                
                tagElement.appendChild(removeButton);
                display.appendChild(tagElement);
            });
        }
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                // Handle multiple tags separated by comma or space
                const values = input.value.split(/[,\s]+/).filter(v => v.trim());
                values.forEach(val => addTag(val.trim()));
                input.value = '';
            }
        });

        input.addEventListener('blur', function() {
            if (input.value.trim()) {
                // Handle multiple tags separated by comma or space
                const values = input.value.split(/[,\s]+/).filter(v => v.trim());
                values.forEach(val => addTag(val.trim()));
                input.value = '';
            }
        });
        
    }

    initTagInput('architectures-input', 'architectures-tags', 'architectures_hidden');
    initTagInput('features-input', 'features-tags', 'features_hidden');
});

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            showCopySuccess();
        }).catch(() => {
            fallbackCopyToClipboard(text);
        });
    } else {
        fallbackCopyToClipboard(text);
    }
}

function fallbackCopyToClipboard(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    try {
        document.execCommand('copy');
        showCopySuccess();
    } catch (err) {
        console.error('Failed to copy text: ', err);
    }
    document.body.removeChild(textarea);
}

function showCopySuccess() {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    button.style.backgroundColor = '#28a745';
    setTimeout(() => {
        button.textContent = originalText;
        button.style.backgroundColor = '';
    }, 2000);
}
</script>
{% endblock %}