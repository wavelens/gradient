<!--
 * SPDX-FileCopyrightText: 2025 Wavelens UG <info@wavelens.io>
 *
 * SPDX-License-Identifier: AGPL-3.0-only
 -->

{% extends 'dashboard/index.html' %}

<head>
    {% load static %}
    {% load i18n %}
</head>

{% block title %}{{ project_data.display_name }}{% endblock %}

{% block content %}

{% url 'settingsProject' org_id project_id as link_url %}
{% include "../individualHeader.html" with link_url=link_url %}

<div class="container">
    <!-- Welcome Section -->
    <div class="header m-b-1rem">
        <div>
            <h1>{{ project_data.display_name }}</h1>
            {% if project_data.description %}
                <p class="text-light">{{ project_data.description }}</p>
            {% else %}
                <p class="text-light">{% trans 'Project in' %} {{ org }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="dashboard-stats m-b-2rem">
        <div class="stat-card">
            <div class="stat-icon">
                <span class="material-symbols-outlined">science</span>
            </div>
            <div class="stat-content">
                <h3>{{ evaluations|length|default:0 }}</h3>
                <p>{% trans 'Total Runs' %}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <span class="material-symbols-outlined">check_circle</span>
            </div>
            <div class="stat-content">
                <h3>{{ successful_evaluations_count|default:0 }}</h3>
                <p>{% trans 'Successful Runs' %}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <span class="material-symbols-outlined">error</span>
            </div>
            <div class="stat-content">
                <h3>{{ failed_evaluations_count|default:0 }}</h3>
                <p>{% trans 'Failed Runs' %}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <span class="material-symbols-outlined">hourglass_empty</span>
            </div>
            <div class="stat-content">
                <h3>{{ running_evaluations_count|default:0 }}</h3>
                <p>{% trans 'Running Runs' %}</p>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">

        <!-- Project Actions -->
        <div class="dashboard-section bordered-section">
            <div class="section-header">
                <h2>{% trans 'Quick Actions' %}</h2>
            </div>
            <div class="section-content">
                <div class="project-actions">
                    <button type="button" class="submit-btn" onclick="startEvaluation('{{ org }}', '{{ project }}')">
                        <span class="material-symbols-outlined">play_arrow</span>
                        {% trans 'Start Evaluation' %}
                    </button>
                    
                    {% if evaluations %}
                        {% for evaluation in evaluations %}
                            {% if evaluation.status == 'running' or evaluation.status == 'pending' %}
                                <button type="button" class="submit-btn danger-btn" onclick="abortEvaluation('{{ evaluation.id }}')">
                                    <span class="material-symbols-outlined">stop</span>
                                    {% trans 'Abort Evaluation' %}
                                </button>
                            {% endif %}
                        {% endfor %}
                    {% endif %}´
                </div>
            </div>
        </div>

        <!-- Recent Evaluations -->
        <div class="dashboard-section bordered-section">
            <div class="section-header">
                <h2>{% trans 'Recent Evaluations' %}</h2>
            </div>
            <div class="section-content">
                {% for evaluation in evaluations|slice:":5" %}
                    <div class="workflow-item dashboard-item">
                        <a href="{% url 'log-eval' org evaluation.id %}" class="full-width normal-hover blue-span">
                            <div class="item-header">
                                <span class="material-symbols-outlined item-icon">science</span>
                                <span class="workflow-title">Evaluation #{{ evaluation.id }}</span>
                            </div>
                            <p class="text-light">
                                {% if evaluation.status == 'running' %}
                                    <span class="material-symbols-outlined">hourglass_empty</span>
                                    {% trans 'Running' %}
                                {% elif evaluation.status == 'completed' %}
                                    <span class="material-symbols-outlined">check_circle</span>
                                    {% trans 'Completed' %}
                                {% elif evaluation.status == 'failed' %}
                                    <span class="material-symbols-outlined">error</span>
                                    {% trans 'Failed' %}
                                {% elif evaluation.status == 'aborted' %}
                                    <span class="material-symbols-outlined">cancel</span>
                                    {% trans 'Aborted' %}
                                {% else %}
                                    <span class="material-symbols-outlined">schedule</span>
                                    {% trans 'Pending' %}
                                {% endif %}
                                • {{ evaluation.created_at|timesince }} ago
                            </p>
                            <div class="item-meta">
                                <span class="flex-c">
                                    <span class="material-symbols-outlined m-r-3">folder</span>
                                    <span class="text-light-n-s">{{ evaluation.builds|length|default:"0" }} builds</span>
                                </span>
                            </div>
                        </a>
                    </div>
                {% empty %}
                    {% if id %}
                    <div class="workflow-item dashboard-item">
                        <a href="{% url 'log-eval' org id %}" class="full-width normal-hover blue-span">
                            <div class="item-header">
                                <span class="material-symbols-outlined item-icon">science</span>
                                <span class="workflow-title">Evaluation #{{ id }}</span>
                            </div>
                            <p class="text-light-n-s flex-c">
                                {% if evalu.status == 'Running' %}
                                    <span class="material-symbols-outlined m-r-3">hourglass_empty</span>
                                    {% trans 'Running' %}
                                {% elif evalu.status == 'Completed' %}
                                    <span class="material-symbols-outlined m-r-3">check_circle</span>
                                    {% trans 'Completed' %}
                                {% elif evalu.status == 'Failed' %}
                                    <span class="material-symbols-outlined m-r-3">error</span>
                                    {% trans 'Failed' %}
                                {% elif evalu.status == 'Aborted' %}
                                    <span class="material-symbols-outlined m-r-3">cancel</span>
                                    {% trans 'Aborted' %}
                                {% else %}
                                    <span class="material-symbols-outlined m-r-3">schedule</span>
                                    {% trans 'Pending' %}
                                {% endif %}
                                • {{ evalu.created_at|timesince }} ago
                            </p>
                            <div class="item-meta">
                                <span class="flex-c">
                                    <span class="material-symbols-outlined m-r-3">folder</span>
                                    <span class="text-light-n-s">{{ evalu.builds|length|default:"0" }} builds</span>
                                </span>
                            </div>
                        </a>
                    </div>
                    {% else %}
                        <div class="no-caches empty-state">
                            <span class="material-symbols-outlined empty-state-icon">science</span>
                            <h3>{% trans 'No evaluations yet' %}</h3>
                            <p>{% trans 'Start your first evaluation to see results here.' %}</p>
                            <button type="button" class="submit-btn empty-state-link" onclick="startEvaluation('{{ org }}', '{{ project }}')">
                                <span class="material-symbols-outlined">play_arrow</span>
                                {% trans 'Start First Evaluation' %}
                            </button>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Project Information -->
        <div class="dashboard-section bordered-section">
            <div class="section-header">
                <h2>{% trans 'Project Information' %}</h2>
            </div>
            <div class="section-content">
                <div class="workflow-item dashboard-item">
                    <div class="full-width normal-hover">
                        <div class="item-header">
                            <span class="material-symbols-outlined item-icon">assignment</span>
                            <span class="workflow-title">{{ project_data.name }}</span>
                        </div>
                        <p class="text-light">{{ project_data.description|default:"No description available"|truncatechars:80 }}</p>
                        <div class="item-meta">
                            {% if project_data.repository %}
                                <span class="flex-c">
                                    <span class="material-symbols-outlined m-r-3">code</span>
                                    <span class="text-light-n-s">
                                        <a href="{{ project_data.repository }}" target="_blank" rel="noopener noreferrer" class="external-link">
                                            Repository
                                            <span class="material-symbols-outlined">open_in_new</span>
                                        </a>
                                    </span>
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

{% csrf_token %}

<script>
async function startEvaluation(org, project) {
    try {
        const response = await fetch(`/api/projects/${org}/${project}/evaluate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.text();
            alert('Failed to start evaluation: ' + error);
        }
    } catch (error) {
        console.error('Error starting evaluation:', error);
        alert('Error starting evaluation: ' + error.message);
    }
}

async function abortEvaluation(evaluationId) {
    if (!confirm('{% trans "Are you sure you want to abort this evaluation?" %}')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/evals/${evaluationId}/abort`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.text();
            alert('Failed to abort evaluation: ' + error);
        }
    } catch (error) {
        console.error('Error aborting evaluation:', error);
        alert('Error aborting evaluation: ' + error.message);
    }
}
</script>

{% endblock %}